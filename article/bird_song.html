<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2021科大讯飞鸟鸣识别比赛总结 | Yibo Liu</title>
    <meta name="description" content="Personal webpage">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.3cf5ef1f.css" as="style"><link rel="preload" href="/assets/js/app.da6b8446.js" as="script"><link rel="preload" href="/assets/js/2.4d7c2de1.js" as="script"><link rel="preload" href="/assets/js/13.00c9c0ca.js" as="script"><link rel="prefetch" href="/assets/js/10.828fe095.js"><link rel="prefetch" href="/assets/js/11.73363121.js"><link rel="prefetch" href="/assets/js/12.66224500.js"><link rel="prefetch" href="/assets/js/14.51cd99da.js"><link rel="prefetch" href="/assets/js/15.79ceeeca.js"><link rel="prefetch" href="/assets/js/16.f6eebb3f.js"><link rel="prefetch" href="/assets/js/17.20e8b7a5.js"><link rel="prefetch" href="/assets/js/18.8645afb5.js"><link rel="prefetch" href="/assets/js/3.a28516b4.js"><link rel="prefetch" href="/assets/js/4.80216183.js"><link rel="prefetch" href="/assets/js/5.93671bdf.js"><link rel="prefetch" href="/assets/js/6.d86c8b7f.js"><link rel="prefetch" href="/assets/js/7.9b937e51.js"><link rel="prefetch" href="/assets/js/8.250fbf9b.js"><link rel="prefetch" href="/assets/js/9.fcb7dc63.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3cf5ef1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yibo Liu</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>2021科大讯飞鸟鸣识别比赛总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/article/bird_song.html#比赛介绍" class="sidebar-link">比赛介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/bird_song.html#相关比赛" class="sidebar-link">相关比赛</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#相关工作" class="sidebar-link">相关工作</a></li></ul></li><li><a href="/article/bird_song.html#观察数据" class="sidebar-link">观察数据</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/bird_song.html#特征提取" class="sidebar-link">特征提取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/bird_song.html#mfcc" class="sidebar-link">MFCC</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#logmelspec" class="sidebar-link">LogMelSpec</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#不同提取特征方式的对比" class="sidebar-link">不同提取特征方式的对比</a></li></ul></li><li><a href="/article/bird_song.html#数据增强" class="sidebar-link">数据增强</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/article/bird_song.html#模型" class="sidebar-link">模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/bird_song.html#vision-transformer" class="sidebar-link">Vision Transformer</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#cnn" class="sidebar-link">CNN</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#cnn特征提取-序列模型（lstm-transformer）" class="sidebar-link">CNN特征提取+序列模型（LSTM/Transformer）</a></li><li class="sidebar-sub-header"><a href="/article/bird_song.html#模型集成" class="sidebar-link">模型集成</a></li></ul></li><li><a href="/article/bird_song.html#致谢" class="sidebar-link">致谢</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2021科大讯飞鸟鸣识别比赛总结">2021科大讯飞鸟鸣识别比赛总结</h1> <p>Yibo Liu, 2021</p> <h2 id="比赛介绍">比赛介绍</h2> <p><strong>赛事链接:</strong> <a href="https://challenge.xfyun.cn/topic/info?type=bird-call" target="_blank" rel="noopener noreferrer">科大讯飞：鸟类鸣叫声识别挑战赛<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>任务描述:</strong> 鸟类鸣叫声识别挑战赛旨在增强自动鸟类鸣叫声识别技术，预测出每个测试音频中出现的鸟类物种。测试音频文件只包含单一的鸟类物种，预测在音频文件级别进行，不需要开始和结束的时间戳，属于单标签分类任务。</p> <p><strong>数据说明:</strong> 训练数据集包含100类鸟声数据，存在类别不均衡，真实背景噪音。不可以使用外部数据及预训练模型，不可以进行人工端点检测。</p> <h3 id="相关比赛">相关比赛</h3> <ol><li><p><a href="https://www.kaggle.com/c/freesound-audio-tagging-2019" target="_blank" rel="noopener noreferrer">Kaggle: Freesound Audio Tagging 2019<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>通用音频分类，多标签。</p> <p><em>The audio data is labeled using a vocabulary of 80 labels from Google’s AudioSet Ontology, covering diverse topics: Guitar and other Musical instruments, Percussion, Water, Digestive, Respiratory sounds, Human voice, Human locomotion, Hands, Human group actions, Insect, Domestic animals, Glass, Liquid, Motor vehicle (road), Mechanisms, Doors, and a variety of Domestic sounds.</em></p></li> <li><p><a href="https://www.kaggle.com/c/birdsong-recognition" target="_blank" rel="noopener noreferrer">Kaggle: Cornell Birdcall Identification<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ol> <h3 id="相关工作">相关工作</h3> <ol><li><p><a href="https://github.com/lRomul/argus-freesound" target="_blank" rel="noopener noreferrer">Kaggle: Freesound Audio Tagging 2019 第一名方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：有完整的音频预处理步骤和模型训练，使用了作者自己写的轻量级深度学习框架<a href="https://github.com/lRomul/argus" target="_blank" rel="noopener noreferrer">argus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。本方案使用了基于CNN的模型，它的数据增强的作用很大，值得参考。该方案是我们的最终提交版本的baseline。</p></li> <li><p><a href="https://www.kaggle.com/daisukelab/creating-fat2019-preprocessed-data" target="_blank" rel="noopener noreferrer">FAT 2019 数据预处理流程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：上述第一名方案所参考的特征提取流程。</p></li> <li><p><a href="https://github.com/ryanwongsa/kaggle-birdsong-recognition" target="_blank" rel="noopener noreferrer">Kaggle: Cornell Birdcall Identification 第一名方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：使用了事件检测的流程，用了语音事件检测的预训练模型PANN。该比赛的任务似乎与本比赛不是很相符，因此没有采用。可参考<a href="https://blog.csdn.net/GioDio/article/details/108673532?utm_medium=distribute.pc_relevant_download.none-task-blog-2~default~searchFromBaidu~default-10.test_version_3&amp;depth_1-utm_source=distribute.pc_relevant_download.none-task-blog-2~default~searchFromBaidu~default-10.test_version_" target="_blank" rel="noopener noreferrer">相关博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></li> <li><p><a href="https://towardsdatascience.com/sound-based-bird-classification-965d0ecacb2b" target="_blank" rel="noopener noreferrer">Poland Birdsong Classification<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：给出了一套数据处理流程，指出了数据现存的一些问题。</p></li></ol> <h2 id="观察数据">观察数据</h2> <ol><li><p><strong>类别比例</strong>（数据包括train set和dev set）。坐标：类别-占比。</p> <p><strong>分析：</strong> 需要处理类别不平衡，考虑（1）重采样（2） Focal Loss。</p> <h4 id=""></h4></li></ol> <p><img src="/article/bird_song/data_stat1.png" alt="类别比例（包括train set和dev set）"></p> <ol start="2"><li><p><strong>音频长度</strong>。坐标：采样点数-样本数。</p> <p><strong>分析：</strong> 需要考虑截取多长的时间片段作为输入。</p></li></ol> <p><img src="/article/bird_song/data_stat2.png" alt="音频长度"></p> <h2 id="特征提取">特征提取</h2> <p>语音的特征提取主要使用MFCC（梅尔倒谱系数），实际应用中发现使用log梅尔谱系数的情况也较多，同时通过比较两种方法得到的频谱图，本次比赛我们采用的是log梅尔谱系数。建议阅读参考资料 <a href="https://www.cnblogs.com/luoqingyu/p/5929389.html" target="_blank" rel="noopener noreferrer">博客园 - 数字信号处理--傅里叶变换<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://zhuanlan.zhihu.com/p/88625876" target="_blank" rel="noopener noreferrer">知乎 - 语音识别第4讲：语音特征参数MFCC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="mfcc">MFCC</h3> <h4 id="设计原理">设计原理</h4> <p><em>根据人耳听觉机理的研究发现，人耳对不同频率的声波有不同的听觉敏感度。从200Hz到5000Hz的语音信号对语音的清晰度影响对大。两个响度不等的声音作用于人耳时，则响度较高的频率成分的存在会影响到对响度较低的频率成分的感受，使其变得不易察觉，这种现象称为掩蔽效应。由于频率较低的声音在内耳蜗基底膜上行波传递的距离大于频率较高的声音，故一般来说，低音容易掩蔽高音，而高音掩蔽低音较困难。在低频处的声音掩蔽的临界带宽较高频要小。所以，人们从低频到高频这一段频带内按临界带宽的大小由密到疏安排一组带通滤波器，对输入信号进行滤波。将每个带通滤波器输出的信号能量作为信号的基本特征，对此特征经过进一步处理后就可以作为语音的输入特征。</em></p> <h4 id="基本流程">基本流程</h4> <p>连续语音 -&gt; 预加重 -&gt;分帧 -&gt; 加窗 -&gt; FFT -&gt; Mel滤波器组 -&gt; 对数运算 -&gt; DCT（离散余弦变换）</p> <p>（1）<strong>预加重</strong>：增强高频部分，即通过一个高通滤波器。频域变换为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mo>(</mo><mi>z</mi><mo>)</mo><mo>=</mo><mn>1</mn><mo>−</mo><mi>μ</mi><msup><mi>z</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">H(z)=1-\mu z^{-1}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord mathit">μ</span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，对应的时域变换为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>(</mo><mi>t</mi><mo>)</mo><mo>=</mo><mi>x</mi><mo>(</mo><mi>t</mi><mo>)</mo><mo>−</mo><mi>α</mi><mi>x</mi><mo>(</mo><mi>t</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">y(t)=x(t)-\alpha x(t)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.0037em;">α</span><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span></span></span></span>，这是实际计算时使用的。
（2）<strong>分帧</strong>：信号的频谱随时间变化，因此对整个信号进行傅立叶变换没有意义。假设频率在很短的时间内是平稳的，所以在短时间帧内进行傅里叶变换。
（3）<strong>加窗</strong>：以增加帧左端和右端的连续性。为了抵消FFT所假设的数据是无限的，并减少频谱泄漏。
（4）<strong>FFT</strong>：时域-&gt;频域
（5）<strong>Mel滤波器组</strong>：一系列滤波器，对不同频率设置不同的门限。
（6）<strong>对数运算</strong>
（7）<strong>DCT（离散余弦变换）</strong>：去除一些变化过快的系数，这些系数在ASR任务中没有帮助。</p> <h4 id="尝试的几种实现">尝试的几种实现</h4> <ol><li><code>librosa.feature.mfcc</code></li></ol> <div class="language-python extra-class"><pre class="language-python"><code>signal<span class="token punctuation">,</span> sample_rate <span class="token operator">=</span> librosa<span class="token punctuation">.</span>load<span class="token punctuation">(</span>wav_file<span class="token punctuation">)</span>
mfcc_feat <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>mfcc<span class="token punctuation">(</span>signal<span class="token punctuation">,</span>sr<span class="token operator">=</span>sample_rate<span class="token punctuation">,</span>n_mfcc<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li><code>python_speech_features.mfcc</code></li></ol> <p><strong>Note:</strong> 以上两种实现不包括预加重。</p> <ol start="3"><li>手动实现</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>fftpack <span class="token keyword">import</span> dct
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">extract_mfcc_feature</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span>sample_rate<span class="token punctuation">,</span>n_mel_flt<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">,</span>n_ceps<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    original_signal<span class="token operator">=</span>signal  <span class="token comment"># signal[0:int(2.5*sample_rate)]</span>
    
    <span class="token comment"># pre emphasise</span>
    pre_emphasis <span class="token operator">=</span> <span class="token number">0.97</span>
    emphasized_signal <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>original_signal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> original_signal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> pre_emphasis <span class="token operator">*</span> original_signal<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># frame</span>
    frame_size <span class="token operator">=</span> <span class="token number">0.025</span>
    frame_stride <span class="token operator">=</span> <span class="token number">0.1</span>
    frame_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>frame_size<span class="token operator">*</span>sample_rate<span class="token punctuation">)</span><span class="token punctuation">)</span>
    frame_step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>frame_stride<span class="token operator">*</span>sample_rate<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    signal_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>emphasized_signal<span class="token punctuation">)</span>
    num_frames <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>signal_length<span class="token operator">-</span>frame_length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>frame_step<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pad_signal_length <span class="token operator">=</span> num_frames <span class="token operator">*</span> frame_step <span class="token operator">+</span> frame_length
    pad_signal <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>emphasized_signal<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>pad_signal_length <span class="token operator">-</span> signal_length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    indices <span class="token operator">=</span> np<span class="token punctuation">.</span>tile<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>frame_length<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>num_frames<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>np<span class="token punctuation">.</span>tile<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num_frames<span class="token operator">*</span>frame_step<span class="token punctuation">,</span>frame_step<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>frame_length<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
    frames <span class="token operator">=</span> pad_signal<span class="token punctuation">[</span>np<span class="token punctuation">.</span>mat<span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># add window</span>
    frames <span class="token operator">*=</span> np<span class="token punctuation">.</span>hamming<span class="token punctuation">(</span>frame_length<span class="token punctuation">)</span>
    
    <span class="token comment"># FFT</span>
    NFFT <span class="token operator">=</span> <span class="token number">512</span>
    mag_frames <span class="token operator">=</span> np<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span>np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>rfft<span class="token punctuation">(</span>frames<span class="token punctuation">,</span> NFFT<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Magnitude of the FFT</span>
    pow_frames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> NFFT<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mag_frames <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 功率谱</span>
    
    <span class="token comment"># Mel filter -&gt; fbanks</span>
    low_freq_mel <span class="token operator">=</span> <span class="token number">0</span>
    nfilt <span class="token operator">=</span> n_mel_flt
    high_freq_mel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2595</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>log10<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sample_rate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    mel_points <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>low_freq_mel<span class="token punctuation">,</span> high_freq_mel<span class="token punctuation">,</span> nfilt <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># Equally spaced in Mel scale</span>
    hz_points <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">700</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span><span class="token punctuation">(</span>mel_points <span class="token operator">/</span> <span class="token number">2595</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Convert Mel to Hz</span>
    <span class="token builtin">bin</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>floor<span class="token punctuation">(</span><span class="token punctuation">(</span>NFFT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> hz_points <span class="token operator">/</span> sample_rate<span class="token punctuation">)</span>
    fbank <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>nfilt<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>NFFT <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nfilt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        f_m_minus <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># left</span>
        f_m <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># center</span>
        f_m_plus <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># right</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>f_m_minus<span class="token punctuation">,</span> f_m<span class="token punctuation">)</span><span class="token punctuation">:</span>
            fbank<span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">-</span> <span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>f_m<span class="token punctuation">,</span> f_m_plus<span class="token punctuation">)</span><span class="token punctuation">:</span>
            fbank<span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> k<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">[</span>m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token builtin">bin</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
    filter_banks <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>pow_frames<span class="token punctuation">,</span> fbank<span class="token punctuation">.</span>T<span class="token punctuation">)</span>
    filter_banks <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>filter_banks <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>eps<span class="token punctuation">,</span> filter_banks<span class="token punctuation">)</span>  <span class="token comment"># Numerical Stability</span>
    filter_banks <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>log10<span class="token punctuation">(</span>filter_banks<span class="token punctuation">)</span>  <span class="token comment"># dB</span>
    
    <span class="token comment"># DCT -&gt; mfcc</span>
    num_ceps <span class="token operator">=</span> n_ceps
    mfcc <span class="token operator">=</span> dct<span class="token punctuation">(</span>filter_banks<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> norm<span class="token operator">=</span><span class="token string">'ortho'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>num_ceps <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">(</span>nframes<span class="token punctuation">,</span> ncoeff<span class="token punctuation">)</span> <span class="token operator">=</span> mfcc<span class="token punctuation">.</span>shape
    
    <span class="token comment"># normalize mfcc</span>
    mfcc <span class="token operator">-=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>mfcc<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> mfcc  <span class="token comment"># (n_frames, n_features)</span>
</code></pre></div><h3 id="logmelspec">LogMelSpec</h3> <p>LogMelSpec与MFCC区别在于它没有DCT。可用的实现是<code>librosa.features.melspectrogram</code>。</p> <div class="language-python extra-class"><pre class="language-python"><code>signal<span class="token punctuation">,</span> sample_rate <span class="token operator">=</span> librosa<span class="token punctuation">.</span>load<span class="token punctuation">(</span>wav_file<span class="token punctuation">)</span>
melspec <span class="token operator">=</span> librosa<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>melspectrogram<span class="token punctuation">(</span>signal<span class="token punctuation">,</span>sr<span class="token operator">=</span>sample_rate<span class="token punctuation">,</span>n_fft<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>hop_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>n_mels<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span>
logmelspec <span class="token operator">=</span> librosa<span class="token punctuation">.</span>power_to_db<span class="token punctuation">(</span>melspec<span class="token punctuation">)</span>
</code></pre></div><h3 id="不同提取特征方式的对比">不同提取特征方式的对比</h3> <p>我们希望通过观察特征图像来判断那种特征更合适。参与对比的有mfcc的两种实现和logmelspec，他们的特征数量（即梅尔滤波器数量）均设置为128，实验代码详见<a href="https://github.com/zll17/BirdRec/blob/main/preprocessing/feature_extract.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。通过对比，我们最终选用logmelspec作为特征。</p> <p><strong>wav时域图：</strong></p> <p><img src="/article/bird_song/wav_img.png" alt="wav_img"></p> <p><strong>librosa.features.mfcc:</strong></p> <p><img src="/article/bird_song/mfcc.png" alt="mfcc"></p> <p><strong>python_speech_features:</strong></p> <p><img src="/article/bird_song/python_speech.png" alt="python_speech"></p> <p><strong>librosa.features.logmelspec:</strong></p> <p><img src="/article/bird_song/logmelspec.png" alt="logmelspec"></p> <h2 id="数据增强">数据增强</h2> <p>目前对语音信号的建模方式为：对整段音频信号提取频谱图，将频谱图视为图像，沿该图像的时间轴取一小段定长片段，放入处理图像的模型中，如CNN等。因此数据增强的对象是提取的特征图像，数据增强会包括截取、加噪等。特征的形状：dim_x=整个音频的帧数，dim_y=特征数量(滤波器个数)。</p> <p>我们主要参考<a href="https://github.com/lRomul/argus-freesound#augmentations" target="_blank" rel="noopener noreferrer">Kaggle: Freesound Audio Tagging 2019 第一名方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，所使用的数据增强包括以下步骤：</p> <ol><li><p><strong>截取片段</strong></p> <p>由于鸟鸣在一段音频中的出现是周期性的，而数据集中音频的长度不一，因此对每段音频***随机***截取一小段（256帧）作为训练数据。长度不够256帧的要补齐。这一步有许多之的改进的地方：</p> <p>（1）具体帧数可以更改，256帧是照搬的freesound方案，应该统计我们数据中每一声鸟鸣的长度是多少，截取的长度要综合考虑鸟鸣长度和鸟鸣间隔。</p> <p>（2）不一定要随机截取，可以辅以端点检测和静音检测（题目中说不可以使用人工端点检测，但我们可以使用自动的），以避免取到不包含鸟鸣的片段。</p> <p>（3）进而引发的思考是，截取片段的方法只用到了局部信息，没有用到全局信息（如鸟鸣间隔，鸟一共名叫多少声等等），因此后续我们尝试了序列模型（CNN特征提取器+LSTM后端）来利用全局信息。</p> <p>% TODO： 加图</p></li> <li><p><strong>随机缩放</strong></p> <p>freesound方案作者称该步骤提升显著，我们照搬了。</p></li> <li><p><strong>加噪</strong></p> <p>我认为有两种思路，一种是给图像加噪，即在特征图像上加矩形/sin函数形的mask；另一种是对原始音频添加白噪声/粉噪声等。</p> <p>我们截至比赛截至时只尝试了freesound使用的矩形mask和我们增加的sin函数形mask。（但提交版本暂未加入sin函数形mask，也尚未实验验证其效果。）图像加噪的效果如下：</p> <p>% TODO：add sin</p> <p><img src="/article/bird_song/mask.png" alt="mask"></p> <p>原始音频加噪的方法可以参考<a href="https://github.com/ryanwongsa/kaggle-birdsong-recognition#data-augmentation" target="_blank" rel="noopener noreferrer">Cornell Birdcall Identification 第一名方案的数据增强<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>， 我个人认为这种加噪方法更符合直觉，值得尝试。</p></li></ol> <p><strong>其他尝试：预加重</strong></p> <p>预加重是在提取特征之前对原始音频的处理，增强高频部分。librosa的logmelspec特征并没有预加重的步骤，因此我们手动添加。</p> <div class="language-python extra-class"><pre class="language-python"><code>signal<span class="token punctuation">,</span>sample_rate <span class="token operator">=</span> librosa<span class="token punctuation">.</span>load<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
pre_emphasis <span class="token operator">=</span> <span class="token number">0.97</span>
pre_emphasised_signal <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>signal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> pre_emphasis <span class="token operator">*</span> signal<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>增加预加重后valid acc提升了1.89%（0.71-&gt;0.7389）。</p> <h2 id="模型">模型</h2> <ul><li>Vision Transformer</li> <li>CNN</li> <li>CNN特征提取+序列模型（LSTM/Transformer）</li></ul> <h3 id="vision-transformer">Vision Transformer</h3> <p>考虑使用Vision Transformer的动机是，Kaggle Freesound和Cornell Birdcall都是2019或2020年的比赛，而Transformer是2019年底才流行起来、Vision Transformer更是2020年才出现，所以以前这些比赛获奖者所采用的CNN方案未必是当下最好的方案。因此我们决定直接上强有力的模型，Vision Transformer。对与分类任务，有<a href="https://arxiv.org/abs/2010.11929" target="_blank" rel="noopener noreferrer">ViT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和CvT。</p> <p><strong>Vision Transformer原理讲解：</strong><a href="https://zhuanlan.zhihu.com/p/348593638" target="_blank" rel="noopener noreferrer">知乎 - Vision Transformer , Vision MLP超详细解读 (原理分析+代码解读)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>可用的开源实现：</strong></p> <ol><li><p><a href="https://github.com/rwightman/pytorch-image-models" target="_blank" rel="noopener noreferrer">timm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一个包含各种视觉模型的库。使用方法可以参考<a href="https://zhuanlan.zhihu.com/p/350837279" target="_blank" rel="noopener noreferrer">知乎 - 视觉Transformer优秀开源工作：timm库vision transformer代码解读<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。官方介绍：<em>PyTorch image models, scripts, pretrained weights -- ResNet, ResNeXT, EfficientNet, EfficientNetV2, NFNet, Vision Transformer, MixNet, MobileNet-V3/V2, RegNet, DPN, CSPNet, and more</em>。</p></li> <li><p><a href="https://github.com/lucidrains/vit-pytorch" target="_blank" rel="noopener noreferrer">vit-pytorch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一个包含各种Vision Transformer的库。</p></li></ol> <h4 id="验证性实验">验证性实验</h4> <p>为了测试ViT的可用性，先在<a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data" target="_blank" rel="noopener noreferrer">Kaggle猫狗分类数据集<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上跑了ViT，准确率为~0.6，这并不高。在我们的Bird 4k数据集上（为方便调试取了一个小数据集，大小为4k，由每类别随机取等数量的样本得到）上得到的准确率为~0.02。</p> <p>为了测试CvT的可用性，先在通用图像分类数据集<a href="http://www.vision.caltech.edu/Image_Datasets/Caltech256/" target="_blank" rel="noopener noreferrer">caltech256<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上跑了CvT，准确率为~0.15。</p> <h4 id="预训练模型">预训练模型</h4> <p>Transformer是在使用了预训练后才大放异彩（BERT），因此这里我们也考虑预训练。因为没有找到现成的Vision Transformer在图像或者在语音数据上的预训练模型，我们打算自己写预训练。能想到的预训练的方法有两种：</p> <ol><li><p><strong>自编码器</strong>。这是非常符合直觉的，但可能不好训练，因为要恢复的内容太多，CvT可能会很复杂。</p></li> <li><p><strong>预测Mask的任务</strong>（像BERT那样）。训练起来可能会更容易（因为预测的内容只是局部），但关键是设计的预测任务要确保合理有效、能帮到后面的分类任务。</p></li></ol> <p>首先我们为CvT设计了自编码器：</p> <p><img src="/article/bird_song/cvt_ptr.png" alt="cvt_ptr"></p> <p>（上面是预训练模型，下面是分类模型）</p> <p>自编码器的解码器目前使用了一个直觉设计的CNN，这里有修改的空间。</p> <p><strong>实验结果：</strong></p> <p>对于caltech256，预训练使用的数据是其训练集，使用了预训练后分类准确率没有提高。可能的原因是预训练的数据不够多，Transformer这种复杂模型很容易在小数据集上过拟合。</p> <p>对于Bird 4k数据集，预训练使用的数据也是4k数据集，无预训练分类准确率~0.02，有预训练分类准确率~0.076，这说明预训练是有效的。训练过程中训练集准确率达0.9以上，说明过拟合了。</p> <p><strong>关于Vision Transformer预训练模型的结论：</strong></p> <p>预训练并非是无效的。实验中观察到预训练模型loss的下降非常缓慢，这可能是由于需要大量数据和时间，而我们数据不够大、也仅跑了最多几百个epoch来观察。BERT的训练花费了3天3夜，起初的效果也并不显著。</p> <p>如不使用预训练则效果比不过CNN，如想要预训练有效则需要大量数据和时间。该预训练模型的改进方向是：（1）搜集更多外部数据（鸟鸣的，或至少是用于音频分类的）（2）修改自编码器的Decoder结构。于是我们暂别Transformer，转投CNN的怀抱。</p> <h3 id="cnn">CNN</h3> <p>从这里开始，我们使用完整数据集训练。在训练Vision Transformer时，为了节约时间，我们使用的是一个大小为4k子数据集。</p> <h4 id="simple-cnn">Simple CNN</h4> <p>首先尝试了一个简单的CNN并使用了batchnorm（<a href="https://github.com/zll17/BirdRec/blob/main/train_script/model_SimpleCNN_dataAug_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），在完整数据集上未使用数据增强得到的结果是valid acc=0.58，使用数据增强得到的结果是valid acc=0.68。此外，也尝试了ResNet101和ResNet50，均未达到更好效果。</p> <div class="language-python extra-class"><pre class="language-python"><code>
<span class="token keyword">class</span> <span class="token class-name">Classifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            ConvBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># (B,64,64,128)</span>
            ConvBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># (B,128,32,64)</span>
            ConvBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># (B,256,16,32)</span>
            ConvBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># (B,512,8,16)</span>
        <span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>PReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>       <span class="token comment">#[B,512,8,16]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>avg_pool2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">#[B,512,4,8]</span>
        <span class="token comment">#x,_ = x.max(dim=-1)    #[B,512,4,1]</span>
        x <span class="token operator">=</span> rearrange<span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token string">'B C H W -&gt; B C (H W)'</span><span class="token punctuation">)</span> <span class="token comment">#[B,512,32]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token comment">#[B,512,1]</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment">#[B,512]</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>x<span class="token punctuation">)</span>         <span class="token comment">#[B,num_class]</span>
        <span class="token keyword">return</span> x
</code></pre></div><h4 id="改进的cnn：auxskipattn">改进的CNN：AuxSkipAttn</h4> <p>进而尝试了freesound方案的模型AuxSkipAttn（<a href="https://github.com/zll17/BirdRec/blob/main/train_script/model_AuxSkipAttn_dataAug_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）作为baseline，简言之它是一个添加了Attention，Skip connection和Auxiliary classifier的CNN，得到的结果是valid acc=0.72，提交测试结果test acc=0.64。这个结果说明测试数据和训练数据分布不一致，因此训练数据不平衡的问题需要引起重视并解决。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> models<span class="token punctuation">.</span>aux_skip_attention <span class="token keyword">import</span> AuxSkipAttention

<span class="token keyword">class</span> <span class="token class-name">Classifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>aux_skip_attn <span class="token operator">=</span> AuxSkipAttention<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>base_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>dropout<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span>ratio<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>last_filters<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>last_fc<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>aux_weights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x<span class="token punctuation">,</span> aux3<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1 <span class="token operator">=</span> self<span class="token punctuation">.</span>aux_skip_attn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x<span class="token punctuation">,</span> aux3<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1
</code></pre></div><h4 id="预训练模型-2">预训练模型</h4> <p>图像领域CNN的预训练模型已经广泛使用，因次希望音频特征图也能用上。首先，挪用通用图像分类的预训练模型如ResNet等是不可取的，因为图像的差异太大。其次，我们尝试寻找通用的音频特征图的CNN预训练模型，未果。因此我们决定自己训一个鸟鸣音频的预训练模型。</p> <p>为了扩大训练数据，我们搜集了许多外部数据集，包括：</p> <ul><li><p><a href="https://www.kaggle.com/c/freesound-audio-tagging-2019/data" target="_blank" rel="noopener noreferrer">Kaggle Freesound Auto Tagging 2019 dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.kaggle.com/rtatman/british-birdsong-dataset" target="_blank" rel="noopener noreferrer">British Birdsong Dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.kaggle.com/c/birdsong-recognition/data" target="_blank" rel="noopener noreferrer">Kaggle: Cornell Birdcall Identification dataset<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <p>这次我们采用了将预测Mask作为任务的预训练方案(<a href="https://github.com/zll17/BirdRec/blob/main/train_script/model_MaskPretrain_dataAug_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。mask的长度取为32。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ConvDecoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>input_dim<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>outsz_h<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>outsz_w<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvDecoder<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span>input_dim<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>batchnorm <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [4, 1, 1024, 1024]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># [4, 3, 512, 512]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># [4, 3, 256, 256]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># [4, 3, 128, 128]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># [4, 3, 64, 64]</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#[4, 3*4, 32, 32]     </span>
        x <span class="token operator">=</span> rearrange<span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token string">'B (c1 c2) H W -&gt; B c2 (c1 H) W'</span><span class="token punctuation">,</span>c1<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">#[4,4*128,32]  -&gt;  [4,3,128,32]</span>
        <span class="token keyword">return</span> x
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> models<span class="token punctuation">.</span>aux_skip_attention <span class="token keyword">import</span> AuxSkipAttention

<span class="token keyword">class</span> <span class="token class-name">PreTrainer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>hid_dim<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>mask_h<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>mask_w<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>aux_skip_attn <span class="token operator">=</span> AuxSkipAttention<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>hid_dim<span class="token punctuation">,</span>base_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>dropout<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span>ratio<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>last_filters<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>last_fc<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>aux_weights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>decoder <span class="token operator">=</span> ConvDecoder<span class="token punctuation">(</span>input_dim<span class="token operator">=</span>hid_dim<span class="token punctuation">,</span>outsz_h<span class="token operator">=</span>mask_h<span class="token punctuation">,</span>outsz_w<span class="token operator">=</span>mask_w<span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hid<span class="token punctuation">,</span> aux3<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1 <span class="token operator">=</span> self<span class="token punctuation">.</span>aux_skip_attn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># hid=(batch_size,1024)</span>
        hid <span class="token operator">=</span> hid<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>decoder<span class="token punctuation">(</span>hid<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
</code></pre></div><p><strong>实验结果：</strong> 预训练loss下降非常缓慢，训练30epoch后停止，分类器valid acc=0.7。可能的原因：预训练模型没有训好。可改进的点：（1）ConvDecoder可以更好地设计（这里只是凭直觉设计的）（2）预训练使用的4个数据集的数据量为42011，原始数据量为10906，可能仍不够多。</p> <h4 id="规整化隐空间">规整化隐空间</h4> <p>希望各类别的数据能符合高斯混合分布，因此需要对隐空间做一个变换来使之符合这种分布。我们分别尝试了：</p> <ul><li><p><strong>Deep Normalize Flow (DNF)</strong> (<a href="https://github.com/zll17/BirdRec/blob/main/train_script/model_AuxSkipAttn_DNF_dataAug_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p> <p>Flow模型是一种生成式模型，这里利用了其归一化的原理。</p> <p><em>A flow-based generative model is a generative model used in machine learning that explicitly models a probability distribution by leveraging normalizing flow,[1] which is a statistical method using the change-of-variable law of probabilities to transform a simple distribution into a complex one. -- <a href="https://en.wikipedia.org/wiki/Flow-based_generative_model" target="_blank" rel="noopener noreferrer">Wikipedia<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p></li> <li><p><strong>Wasserstein Auto-Encoder (WAE)</strong> (<a href="https://github.com/zll17/BirdRec/blob/main/train_script/model_AuxSkipAttn_WLoss_dataAug_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p></li></ul> <h3 id="cnn特征提取-序列模型（lstm-transformer）">CNN特征提取+序列模型（LSTM/Transformer）</h3> <p>思路是将将整段特征图像切分为若干帧长为128的片段（此前是整段特征图像随机取一个片段，此处要输入全部片段），将AuxAttnSkip作为编码器为每一个128帧长度的片段编码，将编码后的特征序列输入LSTM或Transformer，就像输入embedding后的文本序列。这样做的目的是利用全局信息，而不只是局部信息。该方法有待尝试。</p> <h3 id="模型集成">模型集成</h3> <p>根据许多人的比赛经验，bagging/boosting/stacking能显著提高效果。这里我们仅仅是将同一个模型以不同的随机种子在测试集上预测5或10次，并投票取结果，就获得了test acc从0.64到0.72的提升（该模型的valid acc=0.72）。详见<a href="https://github.com/zll17/BirdRec/blob/main/train_script/pred_AuxSkipAttn_Bird.ipynb" target="_blank" rel="noopener noreferrer">notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="致谢">致谢</h2> <p>感谢队友<a href="https://github.com/zll17" target="_blank" rel="noopener noreferrer">@方阿<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的鼎力支持，期待下一次！ 😃</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/17/2023, 6:38:42 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.da6b8446.js" defer></script><script src="/assets/js/2.4d7c2de1.js" defer></script><script src="/assets/js/13.00c9c0ca.js" defer></script>
  </body>
</html>
